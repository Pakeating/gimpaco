---
import Layout from '../layouts/Layout.astro';
// Importamos el componente para que Astro conozca sus estilos.
import WorkoutHistoryItem from '../components/WorkoutHistoryItem.astro'; 
---

<Layout>
  {/* 
    Incluimos una instancia del componente con display: none. 
    Esto es un truco para forzar a Astro a empaquetar los estilos de WorkoutHistoryItem.astro 
    en el CSS de esta página, haciéndolos disponibles para el contenido generado por el script.
    No se le pasa ningún dato porque no necesita renderizar nada visible.
  */}
  <div style="display: none;">
    <WorkoutHistoryItem />
  </div>

  <div class="history-container">
    <header class="history-header">
      <h1>Historial de Entrenamientos</h1>
      <p>Consulta tus sesiones pasadas para ver tu progreso a lo largo del tiempo.</p>
    </header>

    <div id="history-list-container" class="history-list">
      <p class="loading-message">Cargando historial...</p>
    </div>
  </div>
</Layout>

<style>
  .history-container {
    max-width: 60rem;
    margin: 4rem auto;
    padding: 2rem;
  }

  .history-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .history-header h1 {
    font-family: 'Poppins', sans-serif;
    font-size: 2.25rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
  }

  .history-header p {
    font-family: 'Lato', sans-serif;
    font-size: 1.125rem;
    color: var(--primary-color);
    opacity: 0.9;
  }

  .history-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .loading-message {
    text-align: center;
    font-family: 'Lato', sans-serif;
    font-size: 1.2rem;
    color: var(--primary-color);
    opacity: 0.8;
    padding: 2rem;
  }
</style>

<script>
  // Helper para formatear la fecha
  function formatDate(dateString) {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    const date = new Date(dateString + 'T00:00:00'); // Corregir desfase de zona horaria
    return date.toLocaleDateString('es-ES', options);
  }

  // Helper para crear el HTML de una tarjeta de historial
  function createWorkoutCardHTML(workout) {
    const exercisesHTML = workout.exercises.map(ex => `
      <li class="exercise-item">
        <span class="exercise-name">${ex.name}</span>
        <span class="exercise-details">${ex.sets} series de ${ex.reps} reps con ${ex.weight}kg</span>
      </li>
    `).join('');

    return `
      <div class="history-card">
        <div class="card-header">
          <span class="workout-date">${formatDate(workout.date)}</span>
          <h2 class="workout-name">${workout.name}</h2>
        </div>
        <div class="card-body">
          <h3 class="exercises-title">Ejercicios Realizados</h3>
          <ul class="exercises-list">${exercisesHTML}</ul>
        </div>
      </div>
    `;
  }

  // Función principal para buscar y renderizar los datos
  async function fetchAndRenderHistory() {
    const container = document.getElementById('history-list-container');
    if (!container) return;

    container.innerHTML = '<p class="loading-message">Cargando historial...</p>';

    try {
      const response = await fetch('/api/history');
      if (!response.ok) throw new Error('Network response was not ok');
      
      const workoutHistory = await response.json();

      if (workoutHistory && workoutHistory.length > 0) {
        container.innerHTML = workoutHistory.map(createWorkoutCardHTML).join('');
      } else {
        container.innerHTML = '<p class="loading-message">No hay historial de entrenamientos para mostrar.</p>';
      }
    } catch (error) {
      console.error('Error fetching history:', error);
      container.innerHTML = '<p class="loading-message" style="color: red;">Error al cargar el historial.</p>';
    }
  }

  // Patrón correcto para View Transitions
  document.addEventListener('astro:after-swap', fetchAndRenderHistory);
  fetchAndRenderHistory(); // Ejecutar en la carga inicial
</script>
