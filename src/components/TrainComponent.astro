---
// This component is fully client-side rendered.
---

<div id="train-component-container">
  <div class="loading-panel"><p>Cargando tu entrenamiento...</p></div>
</div>

<style is:global>
  /* Styles inherited and adapted from [id].astro, now global for client-side rendering */
  .container { max-width: 800px; margin: 2rem auto; padding: 0 1.5rem; }
  .loading-panel { text-align: center; padding: 4rem 1rem; }
  .error-panel { text-align: center; padding: 4rem 1rem; }
  .error-panel h2 { font-family: 'Poppins', sans-serif; color: var(--danger-color); }

  .workout-header { text-align: center; margin-bottom: 3rem; border-bottom: 2px solid var(--accent-color); padding-bottom: 1.5rem; }
  .workout-header h1 { font-family: 'Poppins', sans-serif; font-size: 2.8rem; color: var(--primary-color); margin: 0; }
  .workout-header p { font-size: 1.125rem; color: #555; margin-top: 0.5rem; }

  .exercises-container { display: flex; flex-direction: column; gap: 2.5rem; }
  .exercise-card { background-color: var(--white-color); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.07); overflow: hidden; }
  .exercise-card-header { display: flex; align-items: center; gap: 1rem; background-color: #f8f9fa; padding: 1.25rem 1.5rem; border-bottom: 1px solid #e9ecef; }
  .exercise-number { display: flex; justify-content: center; align-items: center; width: 36px; height: 36px; border-radius: 50%; background-color: var(--accent-color); color: var(--white-color); font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.2rem; flex-shrink: 0; }
  .exercise-card-header h2 { font-family: 'Poppins', sans-serif; font-size: 1.6rem; margin: 0; color: var(--primary-color); }
  
  .sets-table { padding: 0.5rem 1.5rem 1.5rem; }
  .table-header, .set-row { display: grid; grid-template-columns: 50px 1.5fr 1.5fr; gap: 1rem; align-items: center; padding: 0.75rem 0; }
  .table-header { font-family: 'Poppins', sans-serif; font-weight: 600; color: #6c757d; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; border-bottom: 2px solid #e9ecef; }
  
  .set-row { border-bottom: 1px solid #f1f3f5; transition: background-color 0.3s ease; }
  .set-row:last-child { border-bottom: none; }
  .set-row.completed { background-color: #f0fff0; /* Light green for completed sets */ }

  .set-cell { font-size: 1rem; color: #343a40; }
  .set-number-cell { font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.1rem; text-align: center; }
  .planned-cell { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; }
  .planned-cell span { background-color: #e9ecef; padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.95rem; }
  
  .performed-cell { display: flex; align-items: center; }
  .input-group { display: flex; align-items: center; gap: 0.5rem; }
  .performance-input { width: 70px; padding: 0.5rem; border: 1px solid #ccc; border-radius: 6px; text-align: center; font-size: 1rem; font-family: 'Lato', sans-serif; background-color: #f8f9fa; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
  .performance-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(0, 128, 128, 0.2); background-color: var(--white-color); }

  .comments-section { margin-top: 3rem; }
  .comments-section label { display: block; font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.2rem; color: var(--primary-color); margin-bottom: 0.75rem; }
  .comments-section textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid #ccc; border-radius: 8px; font-family: 'Lato', sans-serif; font-size: 1rem; resize: vertical; min-height: 100px; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
  .comments-section textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(0, 128, 128, 0.2); }
  
  .finish-workout-section { margin-top: 3rem; text-align: center; }
  .finish-btn { font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.1rem; color: var(--white-color); background: linear-gradient(45deg, var(--accent-color), #00a0a0); border: none; border-radius: 8px; padding: 0.8rem 2rem; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(0, 128, 128, 0.2); }
  .finish-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 128, 128, 0.3); }
  .finish-btn:disabled { background: #999; cursor: not-allowed; transform: none; box-shadow: none; }
  .finish-btn.saved { background: linear-gradient(45deg, var(--success-color), #16a34a); }
  .finish-btn.error { background: linear-gradient(45deg, var(--danger-color), #dc2626); }
</style>

<script>
function initializeTrainComponent() {
  const container = document.getElementById('train-component-container');
  if (!container || container.dataset.initialized) return;
  container.dataset.initialized = 'true';

  let workoutData = null;

  const renderError = () => {
    container.innerHTML = `<div class="error-panel"><h2>Error al Cargar la Rutina</h2><p>No se pudo obtener la rutina. Por favor, inténtalo de nuevo más tarde.</p></div>`;
  };

  const renderWorkout = (workout) => {
    workoutData = workout;
    const exercisesHtml = workout.exercises.map((exercise, index) => `
      <section class="exercise-card" data-exercise-id="${exercise.exerciseId}">
        <div class="exercise-card-header">
          <span class="exercise-number">${index + 1}</span>
          <h2 class="exercise-name">${exercise.name}</h2>
        </div>
        <div class="sets-table">
          <div class="table-header">
            <div class="header-item">Set</div>
            <div class="header-item">Planificado</div>
            <div class="header-item">Realizado</div>
          </div>
          ${exercise.sets.map((set, setIndex) => `
            <div class="set-row" data-set-id="${set.setId}">
              <div class="set-cell set-number-cell">${setIndex + 1}</div>
              <div class="set-cell planned-cell">
                <span class="planned-reps">${set.planned.reps} reps</span>
                <span class="planned-intensity">@ ${set.planned.intensity}</span>
                ${set.planned.weight > 0 ? `<span class="planned-weight">${set.planned.weight} kg</span>` : ''}
              </div>
              <div class="set-cell performed-cell">
                <div class="input-group">
                  <input type="number" placeholder="kg" class="performance-input weight-input" data-field="weight" data-exercise-id="${exercise.exerciseId}" data-set-id="${set.setId}" />
                  <input type="number" placeholder="reps" class="performance-input reps-input" data-field="reps" data-exercise-id="${exercise.exerciseId}" data-set-id="${set.setId}" />
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </section>
    `).join('');

    const workoutHtml = `
      <main class="container">
        <div class="workout-header">
          <h1>${workout.name}</h1>
          <p>Concéntrate, mantén la técnica y supera tus límites.</p>
        </div>
        <div class="exercises-container" data-workout-id="${workout.workoutId}">${exercisesHtml}</div>
        <div class="comments-section">
          <label for="workout-comments">Comentarios del Entrenamiento</label>
          <textarea id="workout-comments" rows="4" placeholder="Añade tus sensaciones, notas sobre la técnica, fatiga, etc."></textarea>
        </div>
        <div class="finish-workout-section">
          <button id="finish-workout-btn" class="finish-btn">Finalizar Entrenamiento</button>
        </div>
      </main>
    `;
    container.innerHTML = workoutHtml;
    addEventListeners();
  };

  const updateSetData = (exerciseId, setId, field, value) => {
    const exercise = workoutData.exercises.find(e => e.exerciseId === exerciseId);
    if (!exercise) return;
    const set = exercise.sets.find(s => s.setId == setId);
    if (!set) return;
    set.performed[field] = value === '' ? null : Number(value);

    const setRow = container.querySelector(`.set-row[data-set-id="${setId}"]`);
    if (set.performed.reps !== null && set.performed.weight !== null) {
      setRow.classList.add('completed');
    } else {
      setRow.classList.remove('completed');
    }
  };

  const saveWorkout = async () => {
    const button = document.getElementById('finish-workout-btn');
    button.disabled = true;
    button.textContent = 'Guardando...';

    workoutData.comments = document.getElementById('workout-comments').value;
    workoutData.completedAt = new Date().toISOString();

    try {
      const response = await fetch('/api/save-workout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(workoutData),
      });
      if (!response.ok) throw new Error('Failed to save workout');
      button.textContent = '¡Guardado!';
      button.classList.add('saved');
    } catch (error) {
      console.error("Error saving workout:", error);
      button.textContent = 'Error al Guardar';
      button.classList.add('error');
      setTimeout(() => {
          button.disabled = false;
          button.textContent = 'Finalizar Entrenamiento';
          button.classList.remove('error');
      }, 3000);
    }
  };

  const addEventListeners = () => {
    container.querySelectorAll('.performance-input').forEach(input => {
      input.addEventListener('input', (e) => {
        const { exerciseId, setId, field } = e.target.dataset;
        updateSetData(exerciseId, setId, field, e.target.value);
      });
    });
    document.getElementById('finish-workout-btn').addEventListener('click', saveWorkout);
  };

  const fetchWorkout = async () => {
    try {
      const response = await fetch('/api/training');
      if (!response.ok) throw new Error(`API responded with status: ${response.status}`);
      const data = await response.json();
      renderWorkout(data);
    } catch (error) {
      console.error("Failed to fetch and render workout:", error);
      renderError();
    }
  };

  fetchWorkout();
}

document.addEventListener('astro:page-load', initializeTrainComponent);
</script>
