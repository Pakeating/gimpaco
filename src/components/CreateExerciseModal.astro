---
import ExerciseForm from './ExerciseForm.astro';
---

<div id="create-exercise-modal" class="modal-overlay">
  <div class="modal-content">
    <button type="button" class="close-modal-btn" aria-label="Cerrar">&times;</button>
    <header class="modal-header">
        <h2>Crear Nuevo Ejercicio</h2>
        <p>AÃ±ade un nuevo ejercicio a tu biblioteca personal para usarlo en futuros entrenamientos.</p>
    </header>
    <div class="modal-body">
        <ExerciseForm />
    </div>
  </div>
</div>

<style>
  /* Styles remain unchanged */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; padding: 1rem; }
  .modal-overlay.is-visible { display: flex; opacity: 1; }
  .modal-content { background: var(--white-color); border-radius: 0.75rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2); width: 100%; max-width: 550px; position: relative; transform: translateY(-20px); transition: transform 0.3s ease; display: flex; flex-direction: column; max-height: 90vh; }
  .modal-overlay.is-visible .modal-content { transform: translateY(0); }
  .close-modal-btn { position: absolute; top: 0.5rem; right: 0.75rem; background: none; border: none; font-size: 2.25rem; color: #aaa; cursor: pointer; line-height: 1; z-index: 10; }
  .modal-header { text-align: center; padding: 2rem 2rem 1.5rem 2rem; border-bottom: 1px solid #eee; flex-shrink: 0; }
  .modal-header h2 { font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1.5rem; color: var(--primary-color); margin: 0 0 0.5rem 0; }
  .modal-header p { font-family: 'Lato', sans-serif; font-size: 1rem; color: var(--primary-color); opacity: 0.8; margin: 0; }
  .modal-body { overflow-y: auto; padding: 2rem; flex-grow: 1; }
</style>

<script>
  function initializeCreateExerciseModal() {
    const modal = document.getElementById('create-exercise-modal');
    // Exit if the modal doesn't exist or has already been initialized.
    if (!modal || modal.dataset.initialized === 'true') {
      return;
    }
    modal.dataset.initialized = 'true';

    const closeModal = () => {
      document.dispatchEvent(new CustomEvent('exercise-modal-closed'));
      modal.classList.remove('is-visible');
    };

    // Listener to open the modal
    document.addEventListener('open-create-exercise-modal', (e) => {
      const { exerciseName } = e.detail;
      const exerciseForm = modal.querySelector('form');

      if (exerciseForm) {
          exerciseForm.reset();
          const responseMessage = exerciseForm.querySelector('#response-message');
          if (responseMessage) {
            responseMessage.textContent = '';
            responseMessage.className = 'response-message';
          }
          const nameInput = exerciseForm.querySelector('#exercise-name');
          if (nameInput) {
            nameInput.value = exerciseName || '';
          }
      }
      modal.classList.add('is-visible');
      const firstInput = modal.querySelector('input[type="text"]');
      if (firstInput) {
        firstInput.focus();
      }
    });

    // Listener for successful exercise creation
    document.addEventListener('exercise-created', () => {
        setTimeout(closeModal, 1200); 
    });

    // Listeners to close the modal via UI elements
    modal.addEventListener('click', (e) => {
      if (e.target === modal || e.target.classList.contains('close-modal-btn')) {
        closeModal();
      }
    });
  }

  // Ensure the modal script runs on initial load and after Astro's page transitions
  document.addEventListener('astro:page-load', initializeCreateExerciseModal);
</script>
